global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend stats
    bind *:7000
    mode http
    stats enable
    stats uri /haproxy?stats
    stats refresh 10s
    stats auth admin:admin  # Added authentication with admin/admin

frontend postgres_write
    bind *:5000
    default_backend postgres_master

frontend postgres_read
    bind *:5001
    default_backend postgres_replicas

backend postgres_master
    option httpchk
    http-check send meth OPTIONS uri /master
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    {% for host in postgres_servers %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:5432 check port 8008
    {% endfor %}

backend postgres_replicas
    option httpchk
    http-check send meth OPTIONS uri /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    {% for host in postgres_servers %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:5432 check port 8008
    {% endfor %}